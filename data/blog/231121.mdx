---
title: 'S3 (Simple Storage Service)ë€'
date: '2023-11-21'
tags: ['Backend, Frontend']
draft: false
summary: 'AWS S3ì™€ pre-signed URLì— ëŒ€í•´ ì•Œì•„ë³´ì!!!!'
images: []
---

ğŸ¦¡ ì‘ì„±ì : ì›ì¤€

## S3 (Simple Storage Service)ë€?

ê¸°ë³¸ì ìœ¼ë¡œ AWS S3ì— ëŒ€í•´ì„œ ì•Œê³ ëŠ” ìˆì„ ê²ƒì´ë‹¤.

ê°„ë‹¨í•˜ê²Œ ì‚´í´ë³´ê³  ì§€ë‚˜ê°€ìë©´,

í™•ì¥ì„±ê³¼ ë°ì´í„° ê°€ìš©ì„± ë° ë³´ì•ˆê³¼ ì„±ëŠ¥ì„ ì œê³µí•˜ëŠ” ì˜¨ë¼ì¸ ì˜¤ë¸Œì íŠ¸ ìŠ¤í† ë¦¬ì§€ ì„œë¹„ìŠ¤ë¼ê³  í•œë‹¤.

ê·¸ë¦¬ê³  S ì•ê¸€ìê°€ 3ê°œë¼ì„œ S3ë¼ê³  í•œë‹¤.

---

## pre-signed URLì´ë€?

ì´ëŠ” ë§ ê·¸ëŒ€ë¡œ AWS ìì›ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ì œê³µí•˜ê¸° ìœ„í•´ì„œ ì‚¬ìš©ë˜ëŠ” ì´ë¦„ ê·¸ëŒ€ë¡œ ì‚¬ì „ì— ì ì ˆí•œ ê¶Œí•œì„ ê°€ì§„ ìê²©ì¦ëª…ì— ì˜í•˜ì—¬ Signed ëœ URLì„ ì˜ë¯¸í•œë‹¤.

AWSì—ì„œëŠ” ì´ëŸ¬í•œ pre-signed URlì„ S3ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ì œê³µí•˜ê³  ìˆë‹¤.

## ì™œ ì‚¬ìš©í•˜ëŠ”ê°€?

1. **ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ì¦ê°€ì— ì˜í•œ í¼í¬ë¨¼ìŠ¤ì— ëŒ€í•œ ë¹„ìš© ê°ì†Œ**

   JSONì„ ì£¼ê³  ë°›ëŠ” ì¼ë°˜ APIì— ë¹„í•´ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ í•˜ëŠ” ì‘ì—…ì€ ë¶€í•˜ê°€ ë§¤ìš° í¬ë‹¤. ë”°ë¼ì„œ ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ ë°±ì—”ë“œ ì„œë²„ë¥¼ ê±°ì³ì„œ ì´ë£¨ì–´ì§€ê²Œ ë˜ë©´ ë°±ì—”ë“œ ì„œë²„ì— ë¶€í•˜ê°€ í¬ê²Œ ê°€í•´ì§ˆ ê²ƒì´ë‹¤.

   í•˜ì§€ë§Œ, í”„ë¡ íŠ¸ì—ì„œ ë°”ë¡œ S3ì— ì—…ë¡œë“œë¥¼ ì§„í–‰í•˜ê²Œ ëœë‹¤ë©´ ìœ„ì™€ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šì•„ì„œ í¼í¬ë¨¼ìŠ¤ ê°ì†Œë¥¼ ì˜ˆë°©í•  ìˆ˜ ìˆë‹¤.

2. **ë³´ì•ˆ**

   í•˜ì§€ë§Œ í”„ë¡ íŠ¸ì—ì„œ ë°”ë¡œ S3ì— ë§ˆìŒëŒ€ë¡œ ì˜¬ë¦´ ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤ë©´ ë‹¹ì—°íˆ ë³´ì•ˆ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.

   ì•„ë¬´ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ ì‚­ì œí•˜ë©´ ê³¤ë€í•  ìˆ˜ ìˆë‹¤ëŠ”ê±´ ë‹¹ì—°í•œ ê²ƒì´ë‹¤.

   ë”°ë¼ì„œ ì •í•´ì§„ ê·œì¹™ ì•ˆì—ì„œ ê´€ë¦¬ë  ìˆ˜ ìˆë„ë¡ í•´ì•¼ í•˜ëŠ”ë°, ì´ë•Œ pre-signed URLì´ í™œìš©ë  ìˆ˜ ìˆë‹¤.

ì¦‰, ë°±ì—”ë“œëŠ” pre-signed URlì„ ìƒì„±í•˜ëŠ” ë³´ì•ˆì ˆì°¨ ì‘ì—…ë§Œ ìˆ˜í–‰í•˜ì—¬ ë°±ì—”ë“œ ì„œë²„ì— ë¶€í•˜ê°€ ë°œìƒí•˜ì§€ ì•Šê³ , ì´ëŸ¬í•œ ì ˆì°¨ë¥¼ í†µí•´ ì •í•´ì§„ ê·œì¹™ ì•ˆì—ì„œë§Œ ê´€ë¦¬ë  ìˆ˜ ìˆë„ë¡ í•˜ì—¬ ë³´ì•ˆ ë˜í•œ ì±™ê¸¸ ìˆ˜ ìˆë‹¤.

---

## ë¡œì§ (ê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ ì§„í–‰í•  ê²ƒì¸ê°€?)

### 1. ìœ ì €ê°€ ì‚¬ì§„ í˜¹ì€ íŒŒì¼ì„ ë“±ë¡ í˜¹ì€ ë“±ë¡ í›„ ì™„ë£Œ ë²„íŠ¼ í´ë¦­ì‹œ

### 2. í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ì—ê²Œ pre-signed URL ë°œê¸‰ ìš”ì²­ (FileNameì„ ë³´ë‚´ì£¼ë©°)

### 3. ì„œë²„ëŠ” pre-signed URL ë°œê¸‰í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì‘ë‹µ

### 4. í´ë¼ì´ì–¸íŠ¸ëŠ” ë°œê¸‰ ë°›ì€ URLì„ ì´ìš©í•˜ì—¬ S3ì— ì§ì ‘ ì—…ë¡œë“œ

### 5. ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ê²Œì„œ ë“±ë¡ í›„ ê²°ê³¼ ì£¼ì†Œ URLì„ ë°›ì•„ì„œ ì´ì™¸ì˜ ì •ë³´ì™€ í•¨ê»˜ ì²˜ë¦¬ (DB ì €ì¥ ë“±)

---

## ì‚¬ìš© ì„¤ì • ë° êµ¬í˜„

1. ìš°ì„ , S3 Bucketì˜ ì •ì±…ì— PutObjectì™€ GetObjectë¥¼ í¼ë¸”ë¦­ ì•¡ì„¸ìŠ¤ë¡œ ì„¤ì •í•´ì¤€ë‹¤.
2. S3ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ê°€ì§€ëŠ” IAMì„ ë§Œë“¤ì–´ì£¼ê³ , ì¸ì¦í‚¤ë¥¼ ë°›ì•„ë‘”ë‹¤.
3. SpringBootì˜ `application.yml` ì— ë³¸ì¸ì˜ ì¸ì¦í‚¤ë¥¼ ì¶”ê°€í•œë‹¤.

   ```yaml
   cloud:
     aws:
       s3:
         bucket: post-graduate
         prefix-profile: post-graduate-profile
         prefix-certification: post-graduate-certification
       credentials:
         instance-profile: false
         access-key: (ë³¸ì¸ì˜ access-key)
         secret-key: (ë³¸ì¸ì˜ secret-key)
       region:
         auto: false
         static: ap-northeast-2
       stack:
         auto: false
   ```

4. S3 ê´€ë ¨ ì„¤ì •ì„ í•´ì£¼ëŠ” `S3Config` í´ë˜ìŠ¤ ì‘ì„±

   ```java
   @Configuration
   public class S3Config {

       @Value("${cloud.aws.credentials.access-key}")
       public String accessKey;
       @Value("${cloud.aws.credentials.secret-key}")
       public String secretKey;
       @Value("${cloud.aws.region.static}")
       public String region;

       @Bean
       public AmazonS3Client amazonS3Client() {
           AWSCredentials credentials = new BasicAWSCredentials(accessKey, secretKey);
           return (AmazonS3Client)
                   AmazonS3ClientBuilder.standard()
                           .withCredentials(new AWSStaticCredentialsProvider(credentials))
                           .withRegion(region)
                           .build();
       }
   }
   ```

5. S3ì˜ pre-signed URLì„ ë°œê¸‰ë°›ëŠ” ì‘ì—…ì„ í•˜ëŠ” `S3Service` í´ë˜ìŠ¤ ì‘ì„±

   ```java
   @Service
   @RequiredArgsConstructor
   @Slf4j
   public class S3Service {
       private final AmazonS3Client amazonS3;
       @Value("${cloud.aws.s3.bucket}")
       private String bucket;
       @Value("${cloud.aws.s3.prefix-profile}")
       private String prefixProfile;
       @Value("${cloud.aws.s3.prefix-certification}")
       private String prefixCertification;

       /**
        * @param fileName : ì–´ë–¤ íŒŒì¼ì„ ì €ì¥í•  ê²ƒì¸ê°€ (íŒŒì¼ëª…)
        * @return
        */
       public String getProfilePreSignedUrl(String fileName) {
           fileName = prefixProfile + "/" + fileName;
           GeneratePresignedUrlRequest generatePresignedUrlRequest = getGeneratePreSignedUrlRequest(bucket, fileName);
           URL url = amazonS3.generatePresignedUrl(generatePresignedUrlRequest);
           return url.toString();
       }

       public String getCertificationPreSignedUrl(String fileName) {
           fileName = prefixCertification + "/" + fileName;
           GeneratePresignedUrlRequest generatePresignedUrlRequest = getGeneratePreSignedUrlRequest(bucket, fileName);
           URL url = amazonS3.generatePresignedUrl(generatePresignedUrlRequest);
           return url.toString();
       }

       private GeneratePresignedUrlRequest getGeneratePreSignedUrlRequest(String bucket, String fileName) {
           GeneratePresignedUrlRequest generatePresignedUrlRequest =
                   new GeneratePresignedUrlRequest(bucket, fileName)
                           .withMethod(PUT)
                           .withExpiration(getPreSignedUrlExpiration());
           generatePresignedUrlRequest.addRequestParameter(
                   Headers.S3_CANNED_ACL,
                   CannedAccessControlList.PublicRead.toString());
           return generatePresignedUrlRequest;
       }

       private Date getPreSignedUrlExpiration() {
           Date expiration = new Date();
           long expTimeMillis = expiration.getTime();
           expTimeMillis += 1000 * 60 * 2; // 2ë¶„ë™ì•ˆ ê°€ëŠ¥í•˜ë„ë¡
           expiration.setTime(expTimeMillis);
           log.info(expiration.toString());
           return expiration;
       }
   }
   ```

   - bucket: ë²„í‚· ì´ë¦„
   - prefix~~: ë²„í‚· ë‚´ ë””ë ‰í† ë¦¬ ì´ë¦„
   - fileName: ì—…ë¡œë“œ í•˜ê³ ì í•˜ëŠ” íŒŒì¼ëª…

   ì´ë ‡ê²Œ ë³€ìˆ˜ë“¤ì„ ê°€ì§€ê³  ì§„í–‰ì„ í•˜ëŠ”ë°, ìœ„ì˜ ê²½ìš°

   `getGeneratePreSignedUrlRequest` ëŠ” `getPreSignedUrlExpiration` ì„ í†µí•´ ì›í•˜ëŠ” ë²„í‚·ì—, ì›í•˜ëŠ” ë””ë ‰í† ë¦¬ì— ëŒ€í•´ **ì¼ì • ì‹œê°„(**`.withExpiration()`**)**íŒŒì¼ì„ **ì˜¬ë¦´ ìˆ˜ ìˆëŠ”(**`.withMethod(PUT)`**)** ê¶Œí•œì„ ê°€ì§€ëŠ” pre-signed URLì„ ìƒì„±í•´ì£¼ëŠ” ë©”ì†Œë“œì´ë‹¤.

   ë”°ë¼ì„œ fileNameì„ ê°€ì§€ê³  `getProfilePreSignedUrl` í˜¹ì€ `getCertificationPreSignedUrl` ì„ í˜¸ì¶œí•˜ë©´ í•´ë‹¹ ê²½ë¡œì— í•´ë‹¹ íŒŒì¼ì„ ì˜¬ë¦´ ìˆ˜ ìˆëŠ” pre-signed URLì„ ìƒì„±í•´ì¤€ë‹¤.

   ì´ë¥¼ ì»¨íŠ¸ë¡¤ëŸ¬, ì„œë¹„ìŠ¤ ë“±ë“±ì„ ì´ìš©í•˜ì—¬ íŠ¹ì • í˜¸ì¶œì— ë§ì¶°ì„œ ì œê³µí•´ì£¼ë©´ ëœë‹¤.
