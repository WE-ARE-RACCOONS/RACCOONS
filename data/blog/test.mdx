---
title: 'ì‚´ë©´ì„œ ì²˜ìŒ í•´ë³´ëŠ” í†µí•©í…ŒìŠ¤íŠ¸'
date: '2024-01-16'
tags: ['Backend']
draft: false
summary: 'ì‚´ë©´ì„œ ì²˜ìŒ í•´ë³´ëŠ” í†µí•©í…ŒìŠ¤íŠ¸'
images: []
---

ğŸ¦¡ ì‘ì„±ì : ì•„ì—°

## ì‚´ë©´ì„œ ì²˜ìŒ í•´ë³´ëŠ” í†µí•©í…ŒìŠ¤íŠ¸

ê·¸ë˜ì„œ ê·¸ëƒ¥ í¥ì²­ë§ì²­ í…ŒìŠ¤íŠ¸ ë¨

---

ì²˜ìŒ ë‚´ ì‹œë‚˜ë¦¬ì˜¤ëŠ”

1. User ë§Œë“¤ê³ 
2. Mentoring ë§Œë“¤ì–´ì„œ
3. Userì˜ ìƒíƒœë³„ ë©˜í† ë§ ì¡°íšŒí•˜ë©´
4. Mentoringì´ ë‚˜ì˜¨ë‹¤.

ì˜€ëŠ”ë° ì´ëŒ€ë¡œ í•œ ê±´ì§€ëŠ” ì˜ ëª¨ë¥´ê² ë‹¤ .. í•˜í•«

ì¼ë‹¨ ëª¨ë“  í†µí•©í…ŒìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©ë  **Base Class** ë¥¼ ë§Œë“¤ì.

```java
@SpringBootTest
@AutoConfigureMockMvc
@Disabled
@Transactional
public class IntegrationTest {

    @Autowired
    protected MockMvc mvc;

    @Autowired
    private WebApplicationContext ctx;

    @BeforeEach
    void setUp() {
        mvc = MockMvcBuilders
                .webAppContextSetup(ctx)
                .apply(springSecurity())
                .alwaysExpect(status().isOk())
                .alwaysExpect(content().contentType(MediaType.APPLICATION_JSON))
                .build();
    }
}
```

Mock MVCë¥¼ ì„¤ì •í•˜ë ¤ë©´ MockMvcBuildersë¥¼ ì‚¬ìš©í•œë‹¤. ì´ í´ë˜ìŠ¤ëŠ” ì •ì  ë©”ì„œë“œ ë‘ ê°œë¥¼ ì œê³µí•œë‹¤.

- standaloneSetup() : ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•˜ê³  êµ¬ì„±í•œ ì»¨íŠ¸ë¡¤ëŸ¬ í•œ ê°œ ì´ìƒì„ ì„œë¹„ìŠ¤í•  Mock MVCë¥¼ ë§Œë“ ë‹¤.
- webAppContextSetup() : êµ¬ì„±ëœ ì»¨íŠ¸ë¡¤ëŸ¬ í•œ ê°œ ì´ìƒì„ í¬í•¨í•˜ëŠ” ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ Mock MVCë¥¼ ë§Œë“ ë‹¤.

ì´ì œ ë‚´ê°€ ì›í•˜ëŠ” **ì‚¬ìš©ì**ë¡œ ì‹¤í–‰í•˜ëŠ” í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•˜ë‹¤. ì´ë¥¼ ìœ„í•´ì„œëŠ” ìš”ì²­ì— ì¸ì¦ ì •ë³´ë¥¼ ì¶”ê°€í•´ì•¼ í•˜ëŠ”ë° `RequestPostProcessor` ë˜ëŠ” `Annotation`ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

### 1. **RequestPostProcessor ì‚¬ìš©í•˜ê¸°**

- UserRequestPostProcessor.user()

```java
mvc
	.perform(get("/").with(user("user")))

mvc
	.perform(get("/admin").with(user("admin").password("pass").roles("USER","ADMIN")))
```

ì—¬ê¸°ì„œ `user` ëŠ”

```java
public static UserRequestPostProcessor user(String username) {
		return new UserRequestPostProcessor(username);
}
```

ì–˜ë‹¤.

- ê·¸ ì™¸

```java
mvc
	.perform(get("/").with(anonymous()))

mvc
	.perform(get("/").with(authentication(authentication)))

mvc
	.perform(get("/").with(user(userDetails)))

mvc
	.perform(get("/").with(securityContext(securityContext)))
```

### 2. Annotaions **ì‚¬ìš©í•˜ê¸°**

Spring Security í…ŒìŠ¤íŠ¸ ì§€ì›ì„ ì‚¬ìš©í•˜ê¸° ì „ì— ì„¤ì •ì´ í•„ìš”í•˜ë‹¤.

```java
@ExtendWith(SpringExtension.class)
@ContextConfiguration
public class WithMockUserTests {
	// ...
}
```

- @WithMockUser

```java
@WithMockUser

@WithMockUser(username="admin",roles={"USER","ADMIN"})

// ê°’ì— ROLE_ ì ‘ë‘ì‚¬ê°€ ë¶™ì§€ ì•Šê²Œ í•˜ê³ ì‹¶ìœ¼ë©´
@WithMockUser(username = "admin", authorities = { "ADMIN", "USER" })
```

- ê·¸ ì™¸

```java
@WithAnonymousUser

// userDetailsServiceBeanNameì€ UserDetailsService ë¹ˆ ì´ë¦„ì´ë‹¤.
@WithUserDetails(value="username", userDetailsServiceBeanName="authDetailsService")
```

ê¸°ë³¸ì ìœ¼ë¡œ ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ëŠ” JUnitì˜ `@Before` ì´ì „ì— ë°œìƒí•œë‹¤. `@WithUserDetails(setupBefore = TestExecutionEvent.TEST_EXECUTION)` ìœ¼ë¡œ ì„¤ì •í•˜ë©´ JUnitì˜ `@Before` ì´í›„ì— ë°œìƒí•œë‹¤.

---

(( JPA ì¿¼ë¦¬ Method ë¥¼ ì‚¬ìš©í–ˆì„ ë•Œ ì˜ ëŒì•„ê°€ë˜ ì½”ë“œ ^^,, ì§€ê¸ˆì€ ì•ˆ ë¨ ))

```java
class MentoringControllerTest extends IntegrationTest {
    private AuthDetails authDetails;

    @BeforeEach
    void setUp() {
				User user1 = new User(1L, 1L, "mail", "í›„ë°°", "011", "profile", 0, Role.USER, true, now(), now(), false);

        authDetails = new AuthDetails(user1);
        Authentication auth = new UsernamePasswordAuthenticationToken(authDetails, "", authDetails.getAuthorities());
        SecurityContextHolder.getContext().setAuthentication(auth);

        // Create and save the user
        User user2 = new User(100L, 2L, "mail", "ì„ ë°°", "01011111111", "profile", 0, Role.SENIOR, true, LocalDateTime.now(), LocalDateTime.now(), false);
        Senior senior = new Senior(1L, user2, "a", Status.WAITING, 100, new Info(), new Profile(), now(), now());

        // Create and save the mentoring
        Mentoring mentoring = new Mentoring(99L, user1, senior, "topic", "question", "date", 40, 20000, Status.WAITING, LocalDateTime.now(), LocalDateTime.now());
    }

    @Test
    @DisplayName("ëŒ€í•™ìƒì´ ì‹ ì²­í•œ ë©˜í† ë§ ëª©ë¡ ì¡°íšŒ")
    void getWaitingMentorings() throws Exception {
        mvc.perform(get("/mentoring/me/waiting").with(user(authDetails)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value("MT200"))
                .andExpect(jsonPath("$.message").value("ë©˜í† ë§ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤."))
                .andExpect(jsonPath("$.data").isNotEmpty());
    }
}
```

ìœ„ì—ì„œ `with(user("user"))` ë„ ì¨ë³´ê³  `@WithMockUser` ë„ ë‹¤ ì¨ ë´¤ëŠ”ë° í†µê³¼ëŠ” í•¨. ë¬¸ì œëŠ” `mentoring` ì„ ë‹´ì€ `mentoringInfos` ì´ ë°˜í™˜ë  ì¤„ ì•Œì•˜ëŠ”ë° ê³„ì† **ë¹ˆ ë¦¬ìŠ¤íŠ¸**ë§Œ ë°˜í™˜ë¨ ã…œã……ã…œ

ê·¸ë˜ì„œ ê·¸ëƒ¥ responseì˜

- status - 200
- code - "MT200"
- message - "ë©˜í† ë§ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤."
- data - isNotEmpty()

ë§Œìœ¼ë¡œ ë§Œì¡±í•˜ë ¤ê³  í–ˆë‹¤. ì¼ë‹¨ ì‘ë‹µì´ ì˜¤ëŠ” ë° ì˜¤ë¥˜ëŠ” ì•ˆë‚˜ë‹ˆê¹Œ . . .

---

ì´ê²ƒë“¤ ë‹¤ ì¨ë³´ê³  ì•Œì•˜ë‹¤. ë‚˜ëŠ” ì§€ê¸ˆ securityë¥¼ í†µê³¼í•  ì¸ì¦ ì •ë³´ê°€ í•„ìš”í•œ ê²Œ ì•„ë‹ˆë¼ ë©˜í† ë§ì„ ê°€ì§„ ìœ ì €ì˜ í† í°ì´ í•„ìš”í•˜ë‹¤ëŠ” ê²ƒ ğŸ˜‡Â . .

ê·¸ë˜ì„œ

1. í† í°ì„ ë°œê¸‰í•  ìœ ì €(`user`) ë§Œë“¤ê³ 
2. ì„ ë°°(`senior`, `userOfSenior`) ë„ ë§Œë“¤ê³ 
3. ë©˜í† ë§(`mentoring`)ë„ ë§Œë“¤ì—ˆë‹¤

```java
class MentoringControllerTest extends IntegrationTest {
    @Autowired
    private JwtUtils jwtUtil;
    @Autowired
    private UserRepository userRepository;
    @Autowired
    private SeniorRepository seniorRepository;
    @Autowired
    private MentoringRepository mentoringRepository;
    private User user;
    private Senior senior;
    private Long userId;
    private String accessToken;

    @BeforeEach
    void setUp() {
        user = new User(0L, 1L, "mail", "í›„ë°°", "011", "profile", 0, Role.USER, true, now(), now(), false);
        userRepository.save(user);
        userId = user.getUserId();

        User userOfSenior = new User(0L, 2L, "mail", "ì„ ë°°", "012", "profile", 0, Role.SENIOR, true, now(), now(), false);
        userRepository.save(userOfSenior);

        Info info = new Info("major", "ì„œìš¸ëŒ€í•™êµ", "êµìˆ˜ë‹˜", "í‚¤ì›Œë“œ1,í‚¤ì›Œë“œ2", "ë©ì‹¤", "ì¸ê³µì§€ëŠ¥", false, false, "ì¸ê³µì§€ëŠ¥,í‚¤ì›Œë“œ1,í‚¤ì›Œë“œ2");
        Profile profile = new Profile("ì €ëŠ”ìš”", "í•œì¤„ì†Œê°œ", "ëŒ€ìƒ", "chatLink", 40);
        senior = new Senior(0L, userOfSenior, "certification", WAITING, 0, info, profile, now(), now());
        seniorRepository.save(senior);

        accessToken = jwtUtil.generateAccessToken(userId, Role.USER);
    }

    @Test
    @DisplayName("ëŒ€í•™ìƒì´ ì‹ ì²­í•œ ë©˜í† ë§ ëª©ë¡ì„ ì¡°íšŒí•œë‹¤")
    void getWaitingMentorings() throws Exception {
        Mentoring waitingMentoring = new Mentoring(0L, user, senior, "topic", "question", "date", 40, Status.WAITING, now(), now());
        mentoringRepository.save(waitingMentoring);

        mvc.perform(get("/mentoring/me/waiting")
                        .header("Authorization", "Bearer " + accessToken))
								.andDo(print());
    }
```

```json
{
  "code": "MT200",
  "message": "ë©˜í† ë§ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.",
  "data": {
    "mentoringInfos": [
      {
        "mentoringId": 185,
        "seniorId": 114,
        "profile": "profile",
        "nickName": "ì„ ë°°",
        "postgradu": "ì„œìš¸ëŒ€í•™êµ",
        "major": "major",
        "lab": "ë©ì‹¤",
        "term": 40
      }
    ]
  }
}
```

ì´ì œì•¼ ì›í•˜ëŠ” ë©˜í† ë§ì´ ë‚˜ì™”ë‹¤.

ê·¸ëŸ¼ ì •ë§ ê°’ì´ ì˜¬ë°”ë¥¸ì§€ í…ŒìŠ¤íŠ¸í•´ë³´ì.

```java
@Test
@DisplayName("ëŒ€í•™ìƒì´ ì‹ ì²­í•œ ë©˜í† ë§ ëª©ë¡ì„ ì¡°íšŒí•œë‹¤")
void getWaitingMentorings() throws Exception {
    Mentoring waitingMentoring = new Mentoring(0L, user, senior, "topic", "question", "date", 40, Status.WAITING, now(), now());
    mentoringRepository.save(waitingMentoring);

    mvc.perform(get("/mentoring/me/waiting")
                    .header("Authorization", "Bearer " + accessToken))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value("MT200"))
            .andExpect(jsonPath("$.message").value("ë©˜í† ë§ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤."))
            .andExpect(jsonPath("$.data.mentoringInfos[0].profile").value(containsString("profile")))
            .andExpect(jsonPath("$.data.mentoringInfos[0].nickName").value(containsString("ì„ ë°°")))
            .andExpect(jsonPath("$.data.mentoringInfos[0].postgradu").value(containsString("ì„œìš¸ëŒ€í•™êµ")))
            .andExpect(jsonPath("$.data.mentoringInfos[0].major").value(containsString("major")))
            .andExpect(jsonPath("$.data.mentoringInfos[0].lab").value(containsString("ë©ì‹¤")))
            .andExpect(jsonPath("$.data.mentoringInfos[0].term").value(40))
            .andExpect(jsonPath("$.data.mentoringInfos[0].chatLink").doesNotExist())
            .andDo(print());
}
```

JsonPathëŠ” json ê°ì²´ë¥¼ íƒìƒ‰í•˜ê¸° ìœ„í•œ í‘œì¤€í™”ëœ ë°©ë²•ì´ë‹¤.

- ì  í‘œê¸°ë²•

> $.tool.jsonpath.creator.location[2]

- ëŒ€ê´„í˜¸ í‘œê¸°ë²•

> $['tool']['jsonpath']['creator']['location'][2]

ìì„¸í•œ í‘œê¸°ë²•ì€ ì•„ë˜ë¥¼ ì°¸ê³ í•˜ì.

[Introduction to JsonPath | Baeldung](https://www.baeldung.com/guide-to-jayway-jsonpath)

í†µí•©í…ŒìŠ¤íŠ¸ì˜ ë‹¨ì ì€

<aside>
ğŸ§ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜Â ì„¤ì •ê³¼ ëª¨ë“  ë¹ˆë“¤ì„ ìŠ¤ìº”í•˜ì—¬ ë“±ë¡í•˜ê¸° ë•Œë¬¸ì— ë™ì‘ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ê³  ë¬´ê²ë‹¤.

</aside>

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/5eda31ee-1593-4ecf-bfad-bae333b90117/7617dbd8-57e2-42da-9475-c3d81104d3a1/Untitled.png)

ë‚´ê°€ ì˜ëª»ì¨ì„œ ì˜¤ë˜ê±¸ë¦¬ëŠ” ê±´ì§€

ì›ë˜ ì˜¤ë˜ê±¸ë¦¬ëŠ” ê±´ì§€

ì© . . .
