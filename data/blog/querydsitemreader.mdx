---
title: 'QuerydslItemReader ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§Œë“¤ê¸°'
date: '2024-11-10'
tags: ['Backend']
draft: false
summary: 'ì™œ QuerydslItemReader ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë§Œë“¤ì—ˆê³ , ì–´ë–»ê²Œ ë§Œë“¤ì—ˆë‚˜ìš”'
images: []
---

ğŸ¦¡ ì‘ì„±ì : ì›ì¤€

ì°¸ê³  : https://jojoldu.tistory.com/473 (í˜„ ì¸í”„ëŸ° CTO ë‹˜, ì´ë™ìš± ê°œë°œì ë¸”ë¡œê·¸)

## ì„œë¡ 

ê°œì¸ì ìœ¼ë¡œ, SpringBatchì—ì„œ ì œê³µí•´ì£¼ëŠ” ItemReaderì˜ ê²½ìš° ëª¨ë‘ í…ìŠ¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ í•˜ë“œ ì½”ë”© í•´ì•¼í•œë‹¤ëŠ” ì ì´ í° ë¶ˆë§Œì´ì—ˆë‹¤.

í˜„ì¬ëŠ” JdbcItemReaderë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ”ë°, ë§ì€ íšŒì‚¬ì—ì„œ QuerydslItemReaderë¥¼ ì§ì ‘ êµ¬í˜„í•˜ì—¬ ì‚¬ìš©í•˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•˜ê³  ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì¡´ì¬í•˜ë©´ ê°€ì ¸ë‹¤ê°€ ì‚¬ìš©í• ê¹Œ? ì‹¶ê¸°ë„ í–ˆì§€ë§Œ ëŒ€ë¶€ë¶„ì´ SpringBatch 4 ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì–´ ìˆê³  SpringBoot2.xx ê¸°ë°˜ì´ë¼ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê¸°ì—, ê³µë¶€ë„ í• ê²¸, SpringBatch 5ì™€ SpringBoot3.xxì— ë§ê²Œ ì§ì ‘ ë§Œë“¤ì–´ì„œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë§Œë“¤ì–´ë³¼ê¹Œ í•œë‹¤.

## QueryDslItemReader

![](https://efficacious-camel-96c.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F5eda31ee-1593-4ecf-bfad-bae333b90117%2F02bb00c0-2046-4bbe-a935-0cd421036322%2FUntitled.png?table=block&id=c5daa7ba-2fc7-48bb-b394-901ee9c6917e&spaceId=5eda31ee-1593-4ecf-bfad-bae333b90117&width=1420&userId=&cache=v2)

ìš°ì„ , ê¸°ë³¸ì ìœ¼ë¡œ Chunk ì§€í–¥ êµ¬ì¡°ëŠ” ìœ„ì™€ ê°™ì´ ë™ì‘í•œë‹¤.

- `doReadPage()`
  - `page(offset)` ì™€`pageSize(limit)` ì„ í†µí•´ì„œ ë°ì´í„°ë¥¼ ê°€ì§€ê³  ì˜¨ë‹¤.
- `read()`
  - `doReadPage()` ë¡œ ê°€ì ¸ì˜¨ ë°ì´í„°ë“¤ì„ í•˜ë‚˜ì”© processorë¡œ ì „ë‹¬í•œë‹¤.
  - ë§Œì•½ `doReadPage()` ë¡œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ ëª¨ë‘ processorë¡œ ì „ë‹¬í•˜ë©´, ë‹¤ìŒ í˜ì´ì§€ë¥¼ ê°€ì ¸ì˜¤ë„ë¡ ë‹¤ì‹œ `doReadPage()` ë¥¼ í˜¸ì¶œí•œë‹¤.

ìœ„ì˜ ë‚´ìš©ì„ ì•Œì•„ë‘” ì±„ ì§„í–‰í•˜ë„ë¡ í•˜ì.

SpringBatchì˜ AbstractPagingItemReaderë¥¼ êµ¬í˜„í•˜ëŠ” QueryDslItemReaderë¥¼ ë§Œë“¤ì–´ ì‚¬ìš©í•  ê²ƒì¸ë°,

ì´ë¯¸ AbstractPagingItemReaderë¥¼ êµ¬í˜„í•˜ëŠ” JpaPagingItemReaderê°€ ìˆìœ¼ë‹ˆ ì´ë¥¼ ìˆ˜ì •í•˜ì—¬ ë§Œë“¤ ê²ƒì´ë‹¤.

JpaPagingItemReader ì—ì„œ JPQLì´ ìˆ˜í–‰ë˜ëŠ” ë¶€ë¶„ì´ `doReadPage()` ì¸ë°, ì´ ë¶€ë¶„ì„ Querydslì˜ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ë„ë¡ ë³€ê²½í•˜ë©´ ëœë‹¤.

```java
...

	@Override
	@SuppressWarnings("unchecked")
	protected void doReadPage() {

		EntityTransaction tx = null;

		if (transacted) {
			tx = entityManager.getTransaction();
			tx.begin();

			entityManager.flush();
			entityManager.clear();
		} // end if

		Query query = createQuery().setFirstResult(getPage() * getPageSize()).setMaxResults(getPageSize());

		if (parameterValues != null) {
			for (Map.Entry<String, Object> me : parameterValues.entrySet()) {
				query.setParameter(me.getKey(), me.getValue());
			}
		}

		if (results == null) {
			results = new CopyOnWriteArrayList<>();
		}
		else {
			results.clear();
		}

		if (!transacted) {
			List<T> queryResult = query.getResultList();
			for (T entity : queryResult) {
				entityManager.detach(entity);
				results.add(entity);
			} // end if
		}
		else {
			results.addAll(query.getResultList());
			tx.commit();
		} // end if
	}

...
```

ì´ì œ, ì´ JpaPagingItemReaderë¥¼ ìˆ˜ì •í•˜ì—¬ QueryDslPagingItemReaderë¥¼ ë§Œë“¤ì–´ ë³´ì.

```java
public class QueryDslPagingItemReader<T> extends AbstractPagingItemReader<T> {
    protected final Map<String, Object> jpaPropertyMap = new HashMap<>();
    protected EntityManagerFactory entityManagerFactory;
    protected EntityManager entityManager;
    protected Function<JPAQueryFactory, JPAQuery<T>> queryFunction;

    private boolean transacted = true;// default value

    public QueryDslPagingItemReader() {
        setName(ClassUtils.getShortName(QueryDslPagingItemReader.class));
    }

    public QueryDslPagingItemReader(EntityManagerFactory entityManagerFactory, int pageSize,
                                    Function<JPAQueryFactory, JPAQuery<T>> queryFunction) {
        this();
        this.entityManagerFactory = entityManagerFactory;
        this.queryFunction = queryFunction;
        setPageSize(pageSize);
    }

    /**
     * Create a query using an appropriate query provider (entityManager OR
     * queryProvider).
     */
    /**
     * ì´ ë¶€ë¶„ì´ privateì´ê¸° ë•Œë¬¸ì— ìƒˆë¡­ê²Œ ì‘ì„±í•˜ê²Œ ëœ ê²ƒ! overrideí•  ìˆ˜ ì—†ì–´ì„œ
     */
//    private Query createQuery() {
//        if (queryProvider == null) {
//            return entityManager.createQuery(queryString);
//        }
//        else {
//            return queryProvider.createQuery();
//        }
//    }
    /**
     * By default (true) the EntityTransaction will be started and committed around the
     * read. Can be overridden (false) in cases where the JPA implementation doesn't
     * support a particular transaction. (e.g. Hibernate with a JTA transaction). NOTE:
     * may cause problems in guaranteeing the object consistency in the
     * EntityManagerFactory.
     * @param transacted indicator
     */
    public void setTransacted(boolean transacted) {
        this.transacted = transacted;
    }

    @Override
    protected void doOpen() throws Exception {
        super.doOpen();

        entityManager = entityManagerFactory.createEntityManager(jpaPropertyMap);
        if (entityManager == null) {
            throw new DataAccessResourceFailureException("Unable to obtain an EntityManager");
        }
    }

    @Override
    @SuppressWarnings("unchecked")
    protected void doReadPage() {
        clearIfTransacted();

        JPQLQuery<T> query = createQuery()
                .offset(getPage() * getPageSize())
                .limit(getPageSize());

        initResults();

        fetchQuery(query);
    }

    protected void clearIfTransacted() {
        if (transacted) {
            entityManager.clear();
        }
    }

    protected JPAQuery<T> createQuery() {
        JPAQueryFactory queryFactory = new JPAQueryFactory(entityManager);
        return queryFunction.apply(queryFactory);
    }

    protected void initResults() {
        if (CollectionUtils.isEmpty(results)) {
            results = new ArrayList<>();
        } else {
            results.clear();
        }
    }

    protected void fetchQuery(JPQLQuery<T> query) {
        if (!transacted) {
            List<T> queryResult = query.fetch();
            for (T entity : queryResult) {
                entityManager.detach(entity);
                results.add(entity);
            }
        } else {
            results.addAll(query.fetch());
        }
    }

    @Override
    protected void doClose() throws Exception {
        entityManager.close();
        super.doClose();
    }
}
```

ìš°ì„ , Querydslì—ì„œ ëŒë‹¤ í‘œí˜„ì‹ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ë°›ê¸° ìœ„í•´ `Function<JPAQueryFactory, JPAQuery<T>>` ë¥¼ ì‚¬ìš©í•˜ì˜€ê³ , ì´ë¥¼ í†µí•´ JPAQueryFactoryë¥¼ JPAQueryë¡œ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ í•˜ì—¬ Readerì—ì„œ ëŒë‹¤ í‘œí˜„ì‹ìœ¼ë¡œ ì›í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ ë˜ì–´ìˆë‹¤.

ì´ì œ ì´ì–´ì„œ ë©”ì†Œë“œë¥¼ ì‚´í´ë³´ì.

- `doOpen()`

  ```java
  @Override
  protected void doOpen() throws Exception {
      super.doOpen();

      entityManager = entityManagerFactory.createEntityManager(jpaPropertyMap);
      if (entityManager == null) {
          throw new DataAccessResourceFailureException("Unable to obtain an EntityManager");
      }
  }
  ```

  - SpringBatchê°€ ì‹œì‘ë˜ë©´, Readerë¥¼ ì„¸íŒ…í•˜ë©° `doOpen()` ì„ í˜¸ì¶œí•˜ë©´ì„œ EntityManagerê°€ ì„¸íŒ…ëœë‹¤.

- `doReadPage()`

  ```java
  @Override
  protected void doReadPage() {
      clearIfTransacted();

      JPAQuery<T> query = createQuery()
              .offset(getPage() * getPageSize())
              .limit(getPageSize());

      initResults();

      fetchQuery(query);
  }

  protected void clearIfTransacted() {
      if (transacted) {
          entityManager.clear();
      }
  }

  protected JPAQuery<T> createQuery() {
      JPAQueryFactory queryFactory = new JPAQueryFactory(entityManager);
      return queryFunction.apply(queryFactory);
  }

  protected void initResults() {
      if (CollectionUtils.isEmpty(results)) {
          results = new ArrayList<>();
      } else {
          results.clear();
      }
  }

  protected void fetchQuery(JPQLQuery<T> query) {
      if (!transacted) {
          List<T> queryResult = query.fetch();
          for (T entity : queryResult) {
              entityManager.detach(entity);
              results.add(entity);
          }
      } else {
          results.addAll(query.fetch());
      }
  }
  ```

  - ì´ì–´ì„œ `doReadPage()` ê°€ ìˆ˜í–‰ë˜ëŠ”ë°, í˜„ì¬ì˜ í˜ì´ì§€ \* pageSize ë§Œí¼ì„ offsetìœ¼ë¡œ í•˜ë©° pageSizeë§Œí¼ë§Œ ì¡°íšŒí•œë‹¤.
    ê·¸ë¦¬ê³ , `clearIfTransacted()` ê°€ ë­”ê°€ í—ˆì „í•œ ì´ìœ ëŠ” ì•„ë˜ ìë£Œë¥¼ ì°¸ê³ í•˜ë©´ ëœë‹¤.
    https://jojoldu.tistory.com/414
    (ê¸°ì¡´ì˜ ì½”ë“œëŠ” fetchJoinì´ ì ìš©ë˜ì§€ ì•Šì•„ n+1 ë¬¸ì œê°€ ë°œìƒí•œë‹¤ê³  í•œë‹¤.)

ì´ì œ QueryDslItemReaderë¥¼ ë§Œë“¤ì—ˆìœ¼ë‹ˆ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```java
@Bean
public QueryDslPagingItemReader<CreateSalary> salaryReader() {
    return new QueryDslPagingItemReader<Salary>(entityManagerFactory, CHUNK_SIZE, queryFactory ->
             queryFactory.selectFrom(salary)
                     .where(salary.salaryId.eq(1L))
		);
}
```

## QueryDslZeroPagingItemReader

SpringBatchì—ì„œ PagingItemReader ì‚¬ìš©ì‹œ í˜ì´ì§• ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤.

íŠ¹ì • ì¡°ê±´ì„ ê±¸ì–´ë†“ê³  ì¡°íšŒë¥¼ í•˜ëŠ”ë°, processorí˜¹ì€ writerì—ì„œ í•´ë‹¹ ì¡°ê±´ì— ê±¸ë¦¬ê²Œ ìˆ˜ì •ë˜ëŠ” ê²½ìš°ë‹¤.

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” https://www.ywj9811.vercel.app/blog/SpringBatchNoPaging ë¸”ë¡œê·¸ì— í¬ìŠ¤íŒ… í•œê²ƒê³¼ ê°™ì´ ê³„ì† offsetì„ 0ìœ¼ë¡œ ìœ ì§€í•´ì£¼ë©´ ëœë‹¤.

ê·¸ë ‡ê²Œ QueryDslZeroPagingItemReaderë„ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ë°, ë°©ë²•ì€ ê°„ë‹¤í•˜ê²Œ `doReadPage()` ë§Œ ìˆ˜ì •í•´ì£¼ë©´ ëœë‹¤.

```java
public class QueryDslZeroPagingItemReader<T> extends QueryDslPagingItemReader<T> {

    public QueryDslZeroPagingItemReader() {
        super();
        setName(ClassUtils.getShortName(QueryDslZeroPagingItemReader.class));
    }

    public QueryDslZeroPagingItemReader(EntityManagerFactory entityManagerFactory,
                                        int pageSize,
                                        Function<JPAQueryFactory, JPAQuery<T>> queryFunction) {
        this();
        setTransacted(true);
        super.entityManagerFactory = entityManagerFactory;
        super.queryFunction = queryFunction;
        setPageSize(pageSize);
    }

    @Override
    @SuppressWarnings("unchecked")
    protected void doReadPage() {

        JPQLQuery<T> query = createQuery()
                .offset(0)
                .limit(getPageSize());

        initResults();

        fetchQuery(query);
    }
}
```

## QueryDslNoOffsetPagingItemReader

ëŒ€ë¶€ë¶„ì˜ RDBMSë„ ê·¸ë ‡ê³ , í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ Mysqlì€ í˜ì´ì§•ì´ ë’¤ë¡œ ê°ˆìˆ˜ë¡ ëŠë ¤ì§„ë‹¤ëŠ” íŠ¹ì§•ì´ ìˆë‹¤.

```sql
select *
FROM members
WHERE ì¡°ê±´ë¬¸
ORDER BY id DESC
OFFSET í˜ì´ì§€ ë²ˆí˜¸
LIMIT í˜ì´ì§€ ì‚¬ì´ì¦ˆ
```

ì´ìœ ëŠ” ì•„ë˜ì™€ ê°™ì´, ë’· í˜ì´ì§€ë¥¼ ì½ê¸° ìœ„í•´ì„œëŠ” ì•ì—ì„œ ì½ì—ˆë˜ í–‰ë“¤ì„ ì‚¬ìš©í•˜ì§€ ì•Šë”ë¼ë„ ì½ì–´ì•¼í•œë‹¤ëŠ” íŠ¹ì§• ë•Œë¬¸ì´ë‹¤.

ê²°êµ­ offsetì´ 10000ì´ê³ , limitì´ 50ì´ë©´, 10050ê°œë¥¼ ì½ì–´ì•¼ í•˜ëŠ” ê²ƒì´ë‹¤.

![](https://efficacious-camel-96c.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F5eda31ee-1593-4ecf-bfad-bae333b90117%2Fe4c2cc4f-271f-49cc-acda-2aa8ea9e1179%2FUntitled.png?table=block&id=f6f36537-51aa-4972-a710-16bbd5528f9f&spaceId=5eda31ee-1593-4ecf-bfad-bae333b90117&width=1420&userId=&cache=v2)

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ì»¤ë²„ë§ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ê³¼, offsetì„ ì œê±°í•˜ëŠ” ë°©ì‹ì´ ìˆë‹¤.

### ì»¤ë²„ë§ ì¸ë±ìŠ¤ ë°©ì‹

ì´ëŠ” ê¸°ì¡´ì˜ SQLì„ ë‹¤ìŒê³¼ ê°™ì´ ë³€ê²½í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ë‹¤.

```sql
SELECT *
FROM members as m
JOIN (
	SELECT id
	FROM members
	WHERE ì¡°ê±´ë¬¸
	ORDER BY id DESC
	OFFSET í˜ì´ì§€ë²ˆí˜¸
	LIMIT í˜ì´ì§€ì‚¬ì´ì¦ˆ
) as temp
ON temp.id = m.id
```

ì´ëŠ” ì–´ì§¸ì„œ ì´ë“ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒì¼ê¹Œ.

ë’· í˜ì´ì§€ë¥¼ ì½ì„ ë•Œ ì„±ëŠ¥ì´ìŠˆë¥¼ ë°œìƒì‹œí‚¤ëŠ” ë¶€ë¶„ì€, **ì¸ë±ìŠ¤ë¥¼ í†µí•´ ê²€ìƒ‰ì„ í•˜ë”ë¼ë„ ëŒ€ìƒì´ ë˜ëŠ” í–‰ì„ ì½ì–´ì˜¤ê¸° ìœ„í•´ ë‚˜ë¨¸ì§€ ê°’ì— ëŒ€í•œ ë°ì´í„° ë¸”ë¡ì— ì ‘ê·¼í•˜ëŠ” ì‹œê°„ì´ ì˜¤ë˜ê±¸ë¦¬ëŠ” ë¶€ë¶„ì´ë‹¤.**

í•˜ì§€ë§Œ, ì»¤ë²„ë§ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ìœ„ì˜ ì¿¼ë¦¬ì™€ ê°™ì´ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ë° ì´ëŠ” ì¸ë±ìŠ¤ë§Œ ì¡°íšŒë¥¼ í•˜ê³ , í•´ë‹¹ ì¸ë±ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚˜ë¨¸ì§€ ë°ì´í„°ë¥¼ ì–»ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì´ ê°œì„ ëœë‹¤.

![](https://efficacious-camel-96c.notion.site/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F5eda31ee-1593-4ecf-bfad-bae333b90117%2Fec49f768-ca87-452c-914f-8692e95bab1f%2FUntitled.png?table=block&id=f4095314-81f2-4efb-992a-7223a3792d18&spaceId=5eda31ee-1593-4ecf-bfad-bae333b90117&width=1420&userId=&cache=v2)

### offsetì„ ì œê±°í•˜ëŠ” ë°©ì‹

```sql
SELECT *
FROM members
WHERE ì¡°ê±´ë¬¸
AND id < ë§ˆì§€ë§‰ì¡°íšŒ ID #ì§ì „ ì¡°íšŒ ê²°ê³¼ì˜ ë§ˆì§€ë§‰ id
ORDER BY id DESC
LIMIT í˜ì´ì§€ ì‚¬ì´ì¦ˆ
```

offsetì„ ì œê±°í•˜ëŠ” ë°©ì‹ì€ ë§ ê·¸ëŒ€ë¡œ offsetì„ ì œê±°í•˜ê³  ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ëŠ” ë°©ì‹ì´ë‹¤.

ìœ„ì™€ ê°™ì´ id ê¸°ë°˜ìœ¼ë¡œ ë²”ìœ„ë¥¼ ì •í•´ë†“ê³  limitë§Œ ì‚¬ìš©í•œë‹¤ë©´ offsetì„ ì‚¬ìš©í• ë•Œì™€ ë‹¤ë¥´ê²Œ íŠ¹ì • ìœ„ì¹˜ë¶€í„° ì½ê¸° ì‹œì‘í•˜ê¸° ë•Œë¬¸ì— ê¸°ì¡´ì˜ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

### offsetì œê±° ë°©ì‹ ì‚¬ìš©

QueryDslNoOffsetPagingItemReader ì´ë¦„ì—ì„œ ì•Œ ìˆ˜ ìˆë“¯ offsetì„ ì œê±°í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤.

ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

- **JPQLì—ì„œëŠ” fromì ˆì— ì„œë¸Œì¿¼ë¦¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤..!**

ë¬¼ë¡ , UIìƒ í˜ì´ì§• ë²„íŠ¼ì´ í•„ìš”í•œ ê²½ìš°, ë§ˆì§€ë§‰ ì¡°íšŒ IDë¥¼ ì•Œ ìˆ˜ ì—†ëŠ” ê²½ìš° ë“±ë“± offsetì œê±°ì˜ ë²„ì „ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ê²½ìš°ë„ ìˆì§€ë§Œ, í˜„ì¬ ìƒí™©ì—ì„œëŠ” ê³ ë ¤í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” ìƒí™©ì´ë¼ ìƒê´€ì€ ì—†ì„ ê²ƒ ê°™ë‹¤.

(ìœ„ì™€ ê°™ì´ ë¶ˆê°€ëŠ¥í•œ ê²½ìš°ëŠ” QueryDslNoOffsetPagingItemReaderëŠ” ì‚¬ìš©í•˜ì§€ ëª»í•  ìˆ˜ ìˆë‹¤.)

ì´ë¥¼ ìœ„í•´ì„œëŠ” ê¸°ì¡´ì˜ í˜ì´ì§• ì¿¼ë¦¬ì— ë‹¤ìŒê³¼ ê°™ì€ ì¿¼ë¦¬ê°€ ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì–´ì•¼ í•œë‹¤.

```sql
AND id < ë§ˆì§€ë§‰ì¡°íšŒID # ì§ì „ ì¡°íšŒ ê²°ê³¼ì˜ ë§ˆì§€ë§‰ id
ORDER BY id DESC
LIMIT í˜ì´ì§€ì‚¬ì´ì¦ˆ
```

- offsetì´ ì œê±°ëœ limit ì¿¼ë¦¬
- ì¡°íšŒëœ í˜ì´ì§€ì˜ ë§ˆì§€ë§‰ id ê°’ ìºì‹±
- ìºì‹œëœ ë§ˆì§€ë§‰ idê°’ì„ ë‹¤ìŒ í˜ì´ì§€ ì¿¼ë¦¬ ì¡°ê±´ë¬¸ì— ì¶”ê°€
- ì •ë ¬ ê¸°ì¤€ì— ë”°ë¼ ì¡°íšŒ ì¡°ê±´ì— ë§ˆì§€ë§‰ idì˜ ì¡°ê±´ì´ ìë™ í¬í•¨
  - ASC : id > ë§ˆì§€ë§‰ id
  - DESC : id < ë§ˆì§€ë§‰ id

ê·¸ë¦¬ê³  idëŠ” í˜•ì‹ìƒ idë¡œ í‘œí˜„í•œ ê²ƒìœ¼ë¡œ, ìˆ«ì ì´ì™¸ì— ë¬¸ìì—´ ë˜í•œ ì‚¬ìš©ë  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.

ì´ë¥¼ ìœ„í•´ì„œ ëª‡ê°€ì§€ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€ë¡œ ë§Œë“¤ì–´ í•„ìš”ì— ë”°ë¼ ì•Œë§ì€ ì¡°ê±´ì„ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ í•´ì•¼í•œë‹¤.

- QueryDslNoOffsetOptions
  - ì–´ë–¤ í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©í• ì§€ ê²°ì •í•˜ëŠ” ì¶”ìƒ í´ë˜ìŠ¤
  - NumberOptionsì™€ StringOptions ì²˜ëŸ¼ í•˜ìœ„ êµ¬í˜„ì²´ë¥¼ ë§Œë“¤ì–´ ì‚¬ìš©
- Expression
  - where, order by ì¡°ê±´ì„ ë§Œë“¤ì–´ì£¼ëŠ” í´ë˜ìŠ¤
  - ì •ë ¬ ì¡°ê±´ì´ ascì¸ì§€ descì¸ì§€ì— ë”°ë¼ whereì—ì„œ ì¡°ê±´ì„ ì„¤ì •

ì´ëŸ¬í•œ ë‚´ìš©ì„ ê³ ë ¤í•œì±„ ìš°ì„ , ì™„ì„±ëœ QueryDslNoOffsetPagingItemReaderë¥¼ ë³´ì.

```java
public class QueryDslNoOffsetPagingItemReader<T> extends QueryDslPagingItemReader<T> {

    private QueryDslNoOffsetOptions<T> options;

    private QueryDslNoOffsetPagingItemReader() {
        super();
        setName(ClassUtils.getShortName(QueryDslNoOffsetPagingItemReader.class));
    }

    public QueryDslNoOffsetPagingItemReader(EntityManagerFactory entityManagerFactory,
                                            int pageSize,
                                            QueryDslNoOffsetOptions<T> options,
                                            Function<JPAQueryFactory, JPAQuery<T>> queryFunction) {
        super(entityManagerFactory, pageSize, queryFunction);
        setName(ClassUtils.getShortName(QueryDslNoOffsetPagingItemReader.class));
        this.options = options;
    }

    @Override
    @SuppressWarnings("unchecked")
    protected void doReadPage() {
        JPQLQuery<T> query = createQuery().limit(getPageSize());

        initResults();

        fetchQuery(query);

        resetCurrentIdIfNotLastPage();
    }

    @Override
    protected JPAQuery<T> createQuery() {
        JPAQueryFactory queryFactory = new JPAQueryFactory(entityManager);
        JPAQuery<T> query = queryFunction.apply(queryFactory);
        options.initKeys(query, getPage()); // ì œì¼ ì²«ë²ˆì§¸ í˜ì´ì§•ì‹œ ì‹œì‘í•´ì•¼í•  ID ì°¾ê¸°

        return options.createQuery(query, getPage());
    }

    private void resetCurrentIdIfNotLastPage() {
        if (isNotEmptyResults()) {
            options.resetCurrentId(getLastItem());
        }
    }

    // ì¡°íšŒê²°ê³¼ê°€ Emptyì´ë©´ resultsì— nullì´ ë‹´ê¸´ë‹¤
    private boolean isNotEmptyResults() {
        return !CollectionUtils.isEmpty(results) && results.get(0) != null;
    }

    private T getLastItem() {
        return results.get(results.size() - 1);
    }
}
```

ì—¬ê¸°ì„œ ë³´ë©´, `createQuery()` ê°€ ì¢€ ë‹¤ë¥´ë‹¤.

`opions.initKeys(query, getPage())` ë¥¼ í˜¸ì¶œí•˜ê³  ìˆëŠ”ë°, ì œì¼ ì²«ë²ˆì§¸ í˜ì´ì§•ì‹œ ì‹œì‘í•´ì•¼í•  IDë¥¼ ì°¾ëŠ” ì‘ì—…ì´ë‹¤.

```java
@Override
public void initKeys(JPAQuery<T> query, int page) {
    if(page == 0) {
        initFirstId(query);
        initLastId(query);

        log.debug("First Key= {}, Last Key = {}", currentId, lastId);
    }
}

@Override
protected void initFirstId(JPAQuery<T> query) {
    JPAQuery<T> clone = query.clone();
    boolean isGroupByQuery = isGroupByQuery(clone);

    if(isGroupByQuery) {
        currentId = clone
                .select(field)
                .orderBy(expression.isAsc()? field.asc() : field.desc())
                .fetchFirst();
    } else {
        currentId = clone
                .select(expression.isAsc()? field.min(): field.max())
                .fetchFirst();
    }

}

@Override
protected void initLastId(JPAQuery<T> query) {
    JPAQuery<T> clone = query.clone();
    boolean isGroupByQuery = isGroupByQuery(clone);

    if(isGroupByQuery) {
        lastId = clone
                .select(field)
                .orderBy(expression.isAsc()? field.desc() : field.asc())
                .fetchFirst();
    } else {
        lastId = clone
                .select(expression.isAsc()? field.max(): field.min())
                .fetchFirst();
    }
}

@Override
public JPAQuery<T> createQuery(JPAQuery<T> query, int page) {
    if(currentId == null) {
        return query;
    }

    return query
            .where(whereExpression(page))
            .orderBy(orderExpression());
}

private BooleanExpression whereExpression(int page) {
    return expression.where(field, page, currentId)
            .and(expression.isAsc()? field.loe(lastId) : field.goe(lastId));
}

private OrderSpecifier<N> orderExpression() {
    return expression.order(field);
}

//---------------------- ì•„ë˜ëŠ” ì¶”ìƒí´ë˜ìŠ¤ êµ¬í˜„ ë¶€ë¶„ ------------------------

public boolean isGroupByQuery(JPAQuery<T> query) {
    return isGroupByQuery(query.toString());
}

public boolean isGroupByQuery(String sql) {
    return sql.contains("group by");
}
```

ë§Œì•½ pageê°€ 0ì´ë¼ë©´, ì¦‰ ì²«ë²ˆì§¸ í˜ì´ì§€ë¼ë©´ ë‘ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ëŠ”ë°, ê°ê° ë‹¤ìŒê³¼ ê°™ë‹¤.

- `initFirstId()`
  - ìš°ì„ , groupByê°€ ìˆëŠ”ì§€ íŒë‹¨ í›„ ì •ë ¬ëœ ê¸°ì¤€ê³¼ ë™ì¼í•˜ê²Œ ì¡°íšŒí•˜ì—¬ ì²«ë²ˆì§¸ ì¡°íšŒ ê²°ê³¼ë¥¼ Idë¡œ ì„ íƒ
- `initLastId()`
  - ìš°ì„ , groupByê°€ ìˆëŠ”ì§€ íŒë‹¨ í›„ ì •ë ¬ëœ ê¸°ì¤€ê³¼ ë°˜ëŒ€ë¡œ ì¡°íšŒí•˜ì—¬ ì²«ë²ˆì§¸ ì¡°íšŒ ê²°ê³¼ë¥¼ Idë¡œ ì„ íƒ

ê·¸ë¦¬ê³ , `options.createQuery()` ë¥¼ í˜¸ì¶œí•˜ëŠ”ë°, ì—¬ê¸°ì„œëŠ” ì´ì œ currentIdì™€ lastIdë¥¼ ì´ìš©í•˜ì—¬ ì ì ˆí•œ whereê³¼ orderByë¥¼ ë§Œë“¤ì–´ì„œ ì¿¼ë¦¬ë¥¼ ë§Œë“¤ì–´ë‚¸ë‹¤.

ì´í›„ `resetCurrentIdIfNotLastPage()` ë¥¼ í˜¸ì¶œí•˜ëŠ”ë°, ì—¬ê¸°ì„œ currentIdë¥¼ ì €ì¥í•˜ê³ , ë‹¤ìŒ í˜ì´ì§€ì—ì„œ í™œìš©í•˜ëŠ” ê²ƒì´ë‹¤.

ì´ì™¸ì—ë„ Optionsí´ë˜ìŠ¤ì—ì„œ Expressionì„ ì‚¬ìš©í•˜ëŠ” ê²ƒë“¤ì´ ë³´ì´ëŠ”ë°, ì´ëŠ” whereë¬¸ ì‘ì„±ê³¼ orderì—ì„œ ì •ë ¬ ê¸°ì¤€ì„ ì„ íƒí•˜ëŠ”ë° ì‚¬ìš©í•˜ê¸° ìœ„í•œ Enumí´ë˜ìŠ¤ë“¤ì´ë‹¤.

ìì„¸í•œ ì½”ë“œëŠ” ê¹ƒí—ˆë¸Œì— ì¡´ì¬í•œë‹¤.

https://github.com/ywj9811/querydsl-itemreader

ë¬¼ë¡ , ì´ë™ìš± ë‹˜ì˜ ê¹ƒí—ˆë¸Œë¥¼ ì°¸ê³ í•´ë„ ëœë‹¤! ì•„ì£¼ ì•½ê°„ ë¹¼ê³ ëŠ” ê±°ì˜ ê°™ë‹¤.

https://github.com/jojoldu/spring-batch-querydsl

## ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë§Œë“¤ê¸°

```java
plugins {
	...
	id 'maven-publish' //ì¶”ê°€
}

group = 'com.querydslitemreader'
version = '1.0.1' //release ë²„ì „ ëª…ì‹œ

...

repositories {
	...
	maven { url "https://jitpack.io" } //ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§Œë“¤ê¸° ìœ„í•´ jitpackì„ ì´ìš©í•  ê²ƒì´ë‹¤.
}

dependencyManagement {
	imports {
		mavenBom org.springframework.boot.gradle.plugin.SpringBootPlugin.BOM_COORDINATES
	}
}
// ì¶”ê°€

...

publishing {
	publications {
		maven(MavenPublication) {
			groupId = 'com.querydslitemreader.core'
			artifactId = 'pagingitemreader'
			from components.java
			versionMapping {
				usage('java-runtime') {
					fromResolutionResult()
				}
			}
		}
	}
}

```

https://github.com/jitpack/gradle-simple/blob/master/build.gradle

í•´ë‹¹ ì˜ˆì œ ì°¸ê³ í•´ì„œ ë§Œë“¤ë©´ ëœë‹¤.

ê·¸ë¦¬ê³ , java 8ì´ ì•„ë‹Œ ìƒìœ„ ë²„ì „ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ë²„ì „ì„ ì§€ì •í•´ì¤˜ì•¼ buildì‹œì— ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.

ë”°ë¼ì„œ jitpack.ymlì„ ë§Œë“¤ì–´ì¤€ë‹¤.

```yaml
jdk:
  - openjdk17

before_install:
  - sdk install java 17.0.2-zulu
  - sdk use java 17.0.2-zulu
  - sdk install maven
  - mvn -v

install:
  - ./gradlew build -x test publishToMavenLocal
```

ë‚˜ëŠ” java 17ë²„ì „ì„ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ì´ë ‡ê²Œ ë§Œë“¤ì–´ì¤¬ë‹¤.

ê·¸ë¦¬ê³ , buildê°™ì€ ê²½ìš°ëŠ” test ì½”ë“œê°€ ì—†ê¸° ë•Œë¬¸ì— build -x test ë¥¼ ë„£ì–´ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ì§€ ì•Šë„ë¡ ì§€ì •í•œ ê²ƒì´ë‹¤.

ë³¸ì¸ì˜ ìƒí™©ì— ë§ì¶°ì„œ ë§Œë“¤ë©´ ëœë‹¤.

jitpack ì‚¬ìš©ì´ ì˜ ê¸°ì–µì´ ì•ˆë‚˜ëŠ”ë°.. jitpack ë°°í¬ ê²€ìƒ‰í•˜ë©´ ë§ì´ ë‚˜ì˜¤ë‹ˆ í•´ë‹¹ ë‚´ìš©ì„ ë³´ê³  ë”°ë¼í•˜ë©´ ëœë‹¤.

ì´ë ‡ê²Œ ë§Œë“¤ì–´ì£¼ê³ , ê¹ƒí—ˆë¸Œ ë ˆí¬ì§€í† ë¦¬ì—ì„œ Releaseí•´ì£¼ê³  ë‚˜ë©´, https://jitpack.io/ ì—ì„œ ë¹Œë“œ ì„±ê³µ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

í™•ì¸ í›„ ì•„ë˜ì— ë‚˜ì˜¤ëŠ” ë‚´ìš©ì„ ë”°ë¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë‹¤ìš´ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

[GitHub - ywj9811/querydsl-itemreader: QuerydslItemReader for SpringBatch with SpringBoot3.xx](https://github.com/ywj9811/querydsl-itemreader)

ë‚˜ì˜ ê²½ìš° ìœ„ì™€ ê°™ì´ ë§Œë“¤ì–´ì„œ ì‚¬ìš©ì¤‘ì´ë‹ˆ ì°¸ê³ í•˜ë©´ ë§Œë“¤ ìˆ˜ ìˆë‹¤.!
